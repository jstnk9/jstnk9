<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.8">
<link rel="alternate" type="application/rss+xml" href="/jstnk9/blog/rss.xml" title="Welcome to Jstnk webpage RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/jstnk9/blog/atom.xml" title="Welcome to Jstnk webpage Atom Feed">
<link rel="alternate" type="application/rss+xml" href="/jstnk9/research/rss.xml" title="Welcome to Jstnk webpage RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/jstnk9/research/atom.xml" title="Welcome to Jstnk webpage Atom Feed">
<link rel="alternate" type="application/rss+xml" href="/jstnk9/malwareandhunting/rss.xml" title="Welcome to Jstnk webpage RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/jstnk9/malwareandhunting/atom.xml" title="Welcome to Jstnk webpage Atom Feed"><title data-react-helmet="true">TypeRef Hasher- The imphash solution for samples in .NET | Welcome to Jstnk webpage</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://jstnk9.github.io/jstnk9/blog/TypeRef Hasher-The-imphash-solution-for-samples-in-NET"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:title" content="TypeRef Hasher- The imphash solution for samples in .NET | Welcome to Jstnk webpage"><meta data-react-helmet="true" name="description" content="TL;DR"><meta data-react-helmet="true" property="og:description" content="TL;DR"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2021-02-10T00:00:00.000Z"><meta data-react-helmet="true" property="article:author" content="https://twitter.com/Joseliyo_Jstnk"><meta data-react-helmet="true" property="article:tag" content="threat intelligence,malware,reversing,cybersecurity,imphash,typerefhasher"><link data-react-helmet="true" rel="shortcut icon" href="/jstnk9/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://jstnk9.github.io/jstnk9/blog/TypeRef Hasher-The-imphash-solution-for-samples-in-NET"><link data-react-helmet="true" rel="alternate" href="https://jstnk9.github.io/jstnk9/blog/TypeRef Hasher-The-imphash-solution-for-samples-in-NET" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://jstnk9.github.io/jstnk9/blog/TypeRef Hasher-The-imphash-solution-for-samples-in-NET" hreflang="x-default"><link rel="stylesheet" href="/jstnk9/assets/css/styles.26cc7d61.css">
<link rel="preload" href="/jstnk9/assets/js/runtime~main.f4b21a33.js" as="script">
<link rel="preload" href="/jstnk9/assets/js/main.f0c50aa8.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/jstnk9/"><div class="navbar__logo"><img src="/jstnk9/img/msq.png" alt="logo" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/jstnk9/img/msq.png" alt="logo" class="themedImage_TMUO themedImage--dark_uzRr"></div></a><a class="navbar__item navbar__link" href="/jstnk9/docs/intro">Home</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/jstnk9/blog">Blog</a><a class="navbar__item navbar__link" href="/jstnk9/research">Research</a><a class="navbar__item navbar__link" href="/jstnk9/malwareandhunting">Malware &amp; Hunting</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/jstnk9" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">ðŸŒœ</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">ðŸŒž</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_q+wC thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_9G5K margin-bottom--md">All posts</div><ul class="sidebarItemList_6T4b"><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/jstnk9/blog/MISP-object-creator-with-Virustotal-and-Sigma">MISP object creator with VirusTotal and Sigma Galaxies</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/jstnk9/blog/Sigma-Rules-as-MISP-galaxies-02">Sigma Rules as MISP galaxies (II)</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/jstnk9/blog/Sigma-Rules-as-MISP-galaxies">Sigma Rules as MISP galaxies</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/jstnk9/blog/TIBER-EU-ES-Blue-Team-Series-01">TIBER-EU and TIBER-ES - Blue Team</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/jstnk9/blog/ETW-Almulahaza">ETW-Almulahaza - new python-based tool</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/jstnk9/blog/TIBER-EU-ES-Red-Team-Series-01">TIBER-EU and TIBER-ES - Red Team</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/jstnk9/blog/TIBER-EU-ES-Threat-Intelligence-Series-01">TIBER-EU and TIBER-ES - Threat Intelligence (I)</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/jstnk9/blog/Threat-modeling-and-strategic-vision-of-risks">Threat modeling and strategic vision of risks</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/jstnk9/blog/Indicator-life-cycle-applied-to-threat-hunting">Indicator life cycle applied to threat hunting</a></li><li class="sidebarItem_cjdF"><a aria-current="page" class="sidebarItemLink_zyXk sidebarItemLinkActive_wcJs" href="/jstnk9/blog/TypeRef Hasher-The-imphash-solution-for-samples-in-NET">TypeRef Hasher- The imphash solution for samples in .NET</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/jstnk9/blog/Threat-hunting-but-where-and-what-collection-management-framework">Threat Hunting, but... Where and what? - Collection Management Framework</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_d4p0" itemprop="headline">TypeRef Hasher- The imphash solution for samples in .NET</h1><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2021-02-10T00:00:00.000Z" itemprop="datePublished">February 10, 2021</time> Â· <!-- -->7 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/Joseliyo_Jstnk" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_9q7L" src="https://jstnk9.github.io/jstnk9/img/profiles/1574890680450.jpeg" alt="Jose Luis SÃ¡nchez MartÃ­nez"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/Joseliyo_Jstnk" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jose Luis SÃ¡nchez MartÃ­nez</span></a></div><small class="avatar__subtitle" itemprop="description">Security Researcher</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_y2LR" id="tldr">TL;DR<a aria-hidden="true" class="hash-link" href="#tldr" title="Direct link to heading">â€‹</a></h2><p>Lately I am analyzing many malware samples from different families written in C#, C++ and other languages based on the .NET framework (.NET assembly).</p><p>This has led me to find a problem when correlating different samples using hashing techniques, and that is that the imphash in a high percentage was always the same, even with different malware families, however, using other fuzzy hashing techniques I couldnâ€™t find any similarity.</p><p>The problem is due to the fact that during the compilation of the .NET programming languages, the source code is converted into Microsoft Intermediate Language (MSIL), which causes the same imphash to always exist, corresponding in some cases to the import of the <strong>mscoree.dll</strong> DLL and the <strong>_<!-- -->CorExeMain</strong> function.</p><p>I have solved this problem by using another hashing tool called TypeRef Hasher developed by the folks at <a href="https://www.gdatasoftware.com/" target="_blank" rel="noopener noreferrer"> G Data CyberDefense</a>. This tool provides a solution to imphash only for .NET malware samples.</p><p>Taking advantage of the CLI they have available on GitHub, I have developed a small solution that implements and complements it.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="problem">Problem<a aria-hidden="true" class="hash-link" href="#problem" title="Direct link to heading">â€‹</a></h2><p>During the last months, analyzing malware samples that were compiled by some programming language in .NET, I always ran into the same imphash, which in many cases made me believe that I was crazy.</p><p>I was seeing correlations where there werenâ€™t simply because imphash was always the same. For this reason, I started to investigate to see if imphash could really have some kind of bug and I could develop something to fix it, since imphash is one of the indicators I use (from a long list) to correlate malware and to help me later in the attribution processes.</p><p><img src="https://jstnk9.github.io/jstnk9/img/blog-typerefhasher/typeref_1.png" alt="Image_1"></p><p>The top part of the above image is an AsyncRAT sample which, as you can see, has the same imphash as the AgentTesla sample at the bottom (f34d5f2d4577ed6d9ceec516c1f5a744).</p><p>Remembering how imphash works, the hash it produces is based on the DLLs, functions and the order of them in a PE. This fact was what definitely helped me to think that I was not crazy.</p><p><img src="https://jstnk9.github.io/jstnk9/img/blog-typerefhasher/typeref_2.png" alt="Image_2"></p><p>Both malware samples contain the same imported DLL (mscoree.dll) and the same function (<!-- -->_<!-- -->CorExeMain), which must have a reason for this behavior.</p><p>Looking for information about the <!-- -->_<!-- -->CorExeMain function imported from the DLL in the Microsoft Documentation Center they indicate that it has the following functionality:</p><ol><li>Initialize the CLR (Common Language Runtime)</li><li>Finds the entry point in the CLR header of the executable</li><li>Normal PE execution begins</li></ol><p><img src="https://jstnk9.github.io/jstnk9/img/blog-typerefhasher/typeref_3.png" alt="Image_3"></p><p>To summarize, a PE that has been compiled with .NET will have its Entry Point to the <!-- -->_<!-- -->CorExeMain() function of the mscoree.dll DLL, which will ensure that the CLR is loaded to execute the rest of the code.</p><p>Later, at runtime, on demand, the PE will load the rest of the DLLs it needs, that is why in the first instance, the DLLs are not listed in the IAT.</p><p><img src="https://jstnk9.github.io/jstnk9/img/blog-typerefhasher/typeref_4.png" alt="Image_4"></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="solution">Solution<a aria-hidden="true" class="hash-link" href="#solution" title="Direct link to heading">â€‹</a></h2><p>The folks at G Data CyberDefense ran into the same problem as I did recently and came up with a very interesting development to solve this problem.</p><p>They have created a hash called TypeRefHash that is based on the TypeRef Table of PEs in .NET.</p><p>This table stores references to the imported namespaces, having a behavior very similar to that of the DLLs and their functions. For example, if in a PE the DLL Kernel32.dll is imported to make use of the WriteFile function, in a .NET PE the FileStream class of the System.IO namespace can be used.</p><p><img src="https://jstnk9.github.io/jstnk9/img/blog-typerefhasher/typeref_5.png" alt="Image_5"></p><p>In the previous image you can see part of the TypeRef table of the same AsyncRAT sample above, illustrating as an example how it performs the import of the System.IO namespace and the FileStream class.</p><p>All this table is finally used to build a hash (TypeRefHash) with the names and namespaces imported by the PE, something very similar to what imphash does with the DLLs.</p><p>The calculation of the SHA256 hash that they do is based on the following three steps that they indicate in their post.</p><ol><li>They sort the entries by TypeNameSpace and then by TypeName. This is very important, because this way if a new variant of a malware family changes the order of imports, it will not affect the final result of the hash calculation. Empty TypeNameSpaces will be the first to be sorted.</li><li>Concatenate the TypeNamespace and TypeName with a dash. If the TypeNameSpace is empty, the concatenated string begins with the dash.</li><li>All comma-separated strings are joined together and the SHA256 of the resulting UTF8 byte string is then calculated.</li></ol><p>An example could be the following, which I wanted to illustrate in an image as a summary.</p><p><img src="https://jstnk9.github.io/jstnk9/img/blog-typerefhasher/typeref_6.png" alt="Image_6"></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="neossins-development">Neossins development<a aria-hidden="true" class="hash-link" href="#neossins-development" title="Direct link to heading">â€‹</a></h2><p>Based on the G Data CyberDefense tool, I have developed a small application called Neossins in its 0.1 Alpha version, which I will be improving and implementing new features over time.</p><p>The objective pursued by Neossins is first of all to have a structured and comprehensive dataset of TypeRef Hashes on the main .NET malware families, having so far contemplated three:</p><ol><li>AsyncRAT</li><li>Blackshades</li><li>AgentTesla</li></ol><p>Once the information is structured and stored in a database, the next step is to compare malware samples received from different sources with the dataset to identify if there is a match with any TypeRef Hash, and if so, to correlate other samples that have the same hash and that were previously stored in the database.</p><p>Ultimately, it is optimal that new matching samples are stored in the dataset, since the idea is to grow the dataset to be able to know as many TypeRef Hashes as possible for a malware family.</p><p><img src="https://jstnk9.github.io/jstnk9/img/blog-typerefhasher/typeref_7.jpeg" alt="Image_7"></p><p>The tool has been developed in python3 and has some dependencies such as Cytoscape for the generation of the graph that is displayed in a web application that is raised by Dash.</p><p>In a series of tests I have been performing using some downloaded malware samples related to AsyncRAT and AgentTesla, the result was the following.</p><p><img src="https://jstnk9.github.io/jstnk9/img/blog-typerefhasher/typeref_8.png" alt="Image_8"></p><p>The red rectangular nodes are all the samples that I deposited in the directory (the starting point) that must be set in the applicationâ€™s configuration file.</p><p>Starting from the left side (blue zone), you can see that there are five nodes that all share the same TypeRef Hash, which could mean that they are variants belonging to the same family.</p><p>In the central part (red zone), there are three rectangular nodes of red color that are the samples selected to make a comparison with the AsyncRAT family, one of them is the one that has been seen in this post at the beginning of the whole. Two of the three samples, it can be seen that they have a large number of matches previously stored in the dataset, whose nodes are represented by pink circles. All these relationships between nodes means that they share the same TypeRef Hash.</p><p>Finally, on the right side of the screen, seven orphan nodes that have no match with the dataset can be seen, which could be studied to verify if they could be the families mentioned by means of techniques other than TypeRef Hash, and if so, it would be convenient to store the samples in the dataset.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="conclusion">Conclusion<a aria-hidden="true" class="hash-link" href="#conclusion" title="Direct link to heading">â€‹</a></h2><p>The TypeRef Hash solution is one more feature that can be used to identify malware variants on known families.</p><p>As I say and reiterate, it is not a definitive and unique solution to be used for the mentioned task, since it can be perfectly used in parallel with other techniques such as ssdeep, VT vhash, imphash for non-.NET files, etcâ€¦</p><p>The use of imphash for samples compiled using .NET and incorporating only the mscoree.dll DLL and its corresponding <!-- -->_<!-- -->CorExeMain function, has no value since in most cases it will give a false positive in possible relationships of malware samples.</p><p>Little by little I will update Neossins until I have a stable version and incorporate new features that I want to implement in the future.</p><p><strong>Twitter</strong>: <a href="https://twitter.com/Joseliyo_Jstnk" target="_blank" rel="noopener noreferrer">https://twitter.com/Joseliyo_Jstnk</a></p><p><strong>Github</strong>: <a href="https://github.com/jstnk9/neossins" target="_blank" rel="noopener noreferrer">https://github.com/jstnk9/neossins</a></p><p><strong>LinkedIn</strong>: <a href="https://linkedin.com/in/joseluissm/" target="_blank" rel="noopener noreferrer">https://linkedin.com/in/joseluissm/</a></p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_xD8n"><div class="col"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/jstnk9/blog/tags/threat-intelligence">threat intelligence</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/jstnk9/blog/tags/malware">malware</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/jstnk9/blog/tags/reversing">reversing</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/jstnk9/blog/tags/cybersecurity">cybersecurity</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/jstnk9/blog/tags/imphash">imphash</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/jstnk9/blog/tags/typerefhasher">typerefhasher</a></li></ul></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/jstnk9/blog/Indicator-life-cycle-applied-to-threat-hunting"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Â« <!-- -->Indicator life cycle applied to threat hunting</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/jstnk9/blog/Threat-hunting-but-where-and-what-collection-management-framework"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Threat Hunting, but... Where and what? - Collection Management Framework<!-- --> Â»</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#tldr" class="table-of-contents__link toc-highlight">TL;DR</a></li><li><a href="#problem" class="table-of-contents__link toc-highlight">Problem</a></li><li><a href="#solution" class="table-of-contents__link toc-highlight">Solution</a></li><li><a href="#neossins-development" class="table-of-contents__link toc-highlight">Neossins development</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/jstnk9/docs/intro">Home</a></li><li class="footer__item"><a class="footer__link-item" href="/jstnk9/blog">Blog</a></li></ul></div><div class="col footer__col"><div class="footer__title">Social Media</div><ul class="footer__items"><li class="footer__item"><a href="https://twitter.com/Joseliyo_Jstnk" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/joseluissm/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/jstnk9" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2023 Jstnk Website.</div></div></div></footer></div>
<script src="/jstnk9/assets/js/runtime~main.f4b21a33.js"></script>
<script src="/jstnk9/assets/js/main.f0c50aa8.js"></script>
</body>
</html>