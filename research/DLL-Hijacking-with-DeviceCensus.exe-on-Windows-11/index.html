<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.8">
<link rel="alternate" type="application/rss+xml" href="/jstnk9/blog/rss.xml" title="Welcome to Jstnk webpage RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/jstnk9/blog/atom.xml" title="Welcome to Jstnk webpage Atom Feed">
<link rel="alternate" type="application/rss+xml" href="/jstnk9/research/rss.xml" title="Welcome to Jstnk webpage RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/jstnk9/research/atom.xml" title="Welcome to Jstnk webpage Atom Feed">
<link rel="alternate" type="application/rss+xml" href="/jstnk9/malwareandhunting/rss.xml" title="Welcome to Jstnk webpage RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/jstnk9/malwareandhunting/atom.xml" title="Welcome to Jstnk webpage Atom Feed"><title data-react-helmet="true">DLL Hijacking with DeviceCensus.exe on Windows 11 | Welcome to Jstnk webpage</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://jstnk9.github.io/jstnk9/research/DLL-Hijacking-with-DeviceCensus.exe-on-Windows-11"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:title" content="DLL Hijacking with DeviceCensus.exe on Windows 11 | Welcome to Jstnk webpage"><meta data-react-helmet="true" name="description" content="Summary"><meta data-react-helmet="true" property="og:description" content="Summary"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2022-03-24T00:00:00.000Z"><meta data-react-helmet="true" property="article:author" content="https://twitter.com/Joseliyo_Jstnk"><meta data-react-helmet="true" property="article:tag" content="threat hunting,detection,visibility,windows 11,research"><link data-react-helmet="true" rel="shortcut icon" href="/jstnk9/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://jstnk9.github.io/jstnk9/research/DLL-Hijacking-with-DeviceCensus.exe-on-Windows-11"><link data-react-helmet="true" rel="alternate" href="https://jstnk9.github.io/jstnk9/research/DLL-Hijacking-with-DeviceCensus.exe-on-Windows-11" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://jstnk9.github.io/jstnk9/research/DLL-Hijacking-with-DeviceCensus.exe-on-Windows-11" hreflang="x-default"><link rel="stylesheet" href="/jstnk9/assets/css/styles.26cc7d61.css">
<link rel="preload" href="/jstnk9/assets/js/runtime~main.f4b21a33.js" as="script">
<link rel="preload" href="/jstnk9/assets/js/main.f0c50aa8.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/jstnk9/"><div class="navbar__logo"><img src="/jstnk9/img/msq.png" alt="logo" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/jstnk9/img/msq.png" alt="logo" class="themedImage_TMUO themedImage--dark_uzRr"></div></a><a class="navbar__item navbar__link" href="/jstnk9/docs/intro">Home</a><a class="navbar__item navbar__link" href="/jstnk9/blog">Blog</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/jstnk9/research">Research</a><a class="navbar__item navbar__link" href="/jstnk9/malwareandhunting">Malware &amp; Hunting</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/jstnk9" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">ðŸŒœ</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">ðŸŒž</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_q+wC thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_9G5K margin-bottom--md">Recent posts</div><ul class="sidebarItemList_6T4b"><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/jstnk9/research/Malicious-Iran-Document-APT">Malicious document identified in the conflict Israel &amp; Gaza themed about terrorist organizations related to Iran</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/jstnk9/research/GobRAT-Malware">Dissecting GobRAT behaviors - Linux malware</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/jstnk9/research/AsyncRAT-Analysis">Analyzing AsyncRAT distributed in Colombia by Blind Eagle</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/jstnk9/research/Jlaive-Antivirus-Evasion-Tool">Using Jlaive to create batch files from .NET assemblies for defense evasion</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/jstnk9/research/InstallScreenSaver-SCR-files">Executing SCR files using desk.cpl and InstallScreenSaver API Call</a></li><li class="sidebarItem_cjdF"><a aria-current="page" class="sidebarItemLink_zyXk sidebarItemLinkActive_wcJs" href="/jstnk9/research/DLL-Hijacking-with-DeviceCensus.exe-on-Windows-11">DLL Hijacking with DeviceCensus.exe on Windows 11</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_d4p0" itemprop="headline">DLL Hijacking with DeviceCensus.exe on Windows 11</h1><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2022-03-24T00:00:00.000Z" itemprop="datePublished">March 24, 2022</time> Â· <!-- -->3 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/Joseliyo_Jstnk" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_9q7L" src="https://jstnk9.github.io/jstnk9/img/profiles/1574890680450.jpeg" alt="Jose Luis SÃ¡nchez MartÃ­nez"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/Joseliyo_Jstnk" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jose Luis SÃ¡nchez MartÃ­nez</span></a></div><small class="avatar__subtitle" itemprop="description">Security Researcher</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_y2LR" id="summary">Summary<a aria-hidden="true" class="hash-link" href="#summary" title="Direct link to heading">â€‹</a></h2><p><strong>Tested on Windows 11 10.0.22000 N/A Build 22000.</strong></p><p>During January I was investigating Windows 11 and some of the binaries that were installed by default to identify behaviors that could be used for malicious purposes.</p><p>The binary <code>DeviceCensus.exe</code> located in <code>C:\Windows\System32</code>, when is copied to another different path and it is executed, it tries to load more or less 11 DLLs <strong>in the directory where it was executed</strong>. Let&#x27;s say that if you try to execute this binary from <code>AppData</code> path, then it tries to load the DLLs from <code>AppData</code>. However, if the DLL doensn&#x27;t exists in <code>AppData</code>, then it tries to load from <code>System32</code>. </p><p>Then, if you copy this binary in <code>AppData</code> and create a DLL with the same name that tries to load, the DLL is loaded.</p><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>I would like to say that I reported this to MSRC and they told me that <strong>it is not a vulnerability</strong>. They sent me the following information explaining why it is not a vulnerability :). </p><p>Thanks MSRC for explaining!</p><p><strong>Reference 1:</strong> <a href="https://devblogs.microsoft.com/oldnewthing/20150527-00/?p=45024" target="_blank" rel="noopener noreferrer">https://devblogs.microsoft.com/oldnewthing/20150527-00/?p=45024</a></p><p><strong>Reference 2:</strong> <a href="https://msrc-blog.microsoft.com/2018/04/04/triaging-a-dll-planting-vulnerability/" target="_blank" rel="noopener noreferrer">https://msrc-blog.microsoft.com/2018/04/04/triaging-a-dll-planting-vulnerability/</a></p></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="testing-the-behavior">Testing the behavior<a aria-hidden="true" class="hash-link" href="#testing-the-behavior" title="Direct link to heading">â€‹</a></h2><p>First, I moved the binary <code>DeviceCensus.exe</code> to <code>AppData</code> path and executed it.</p><p><img src="https://jstnk9.github.io/jstnk9/img/analysis-devicecensus/device-1.PNG" alt="device-1.png"></p><p>As you can see, there are different DLLs that the binary is trying to load from the path where it was executed. However, some of them can&#x27;t be loaded during the execution.</p><p><img src="https://jstnk9.github.io/jstnk9/img/analysis-devicecensus/device-3.PNG" alt="device-3.png"></p><p>Focusing in the DLL called <code>umpdc.dll</code>, we can see how it was loaded because the first option of load doesn&#x27;t work. It is known as <a href="https://attack.mitre.org/techniques/T1574/001/" target="_blank" rel="noopener noreferrer">DLL Hijacking</a>.</p><p><img src="https://jstnk9.github.io/jstnk9/img/analysis-devicecensus/device-4.PNG" alt="device-4.png"></p><p>However, for this PoC, I&#x27;ve created a DLL called <code>umpdc.dll</code> with a MessageBox. Instead of a MessageBox, it can establish a reverse shell or whatever action (drop another binary and execute it, load in memory malicious code, process injection, etc.)</p><p>Also, for this PoC, Iâ€™ve created a VBS to do the following chain attack:</p><ol><li>Connect to GitHub and Download a DLL</li><li>Drop the DLL in %appdata%</li><li>Copy <code>DeviceCensus.exe</code> from system32 to %appdata%</li><li>Load <code>DeviceCensus.exe</code> in order to load the malicious DLL from path where is executed.</li></ol><p>The initial access could be whatever, either <a href="https://attack.mitre.org/techniques/T1566/002/" target="_blank" rel="noopener noreferrer">spearphising with link</a> or <a href="https://attack.mitre.org/techniques/T1566/001/" target="_blank" rel="noopener noreferrer">spearphishing with attachment</a>. The typical scenario is a office file with macros, which after the execution, connects to remote servers to download a second-stage payload. In this case, I&#x27;ve executed directly <code>wscript.exe</code> to load the VBS file.</p><p><img src="https://jstnk9.github.io/jstnk9/img/analysis-devicecensus/full_chain_dark.png#gh-dark-mode-only" alt="dark"><img src="https://jstnk9.github.io/jstnk9/img/analysis-devicecensus/full_chain_l.png#gh-light-mode-only" alt="light"></p><p>The above image show the <strong>Sysmon Events IDs</strong> (EVID) for each step of the PoC. This can help you to create detections rules for similar scenarios, not focusing only in the DLL and binary. The sysmon configuration used was the one of <a href="https://github.com/SwiftOnSecurity/sysmon-config" target="_blank" rel="noopener noreferrer">SwiftOPneSecurity</a> adding Image Load events.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="poc">PoC<a aria-hidden="true" class="hash-link" href="#poc" title="Direct link to heading">â€‹</a></h2><p>When the VBS file is executed on the target machine, we can see the following events made by <code>wscript.exe</code>. After the execution, the first thing to do is connects to GitHub and download the DLL into the local system.</p><p><img src="https://jstnk9.github.io/jstnk9/img/analysis-devicecensus/device-6.PNG" alt="device-6.png"></p><p>Then, the DLL is created in the <code>AppData</code> path, because we configured it in the VBS script. Also, the file <code>DeviceCensus.exe</code> is copied from <code>C:\Windows\System32</code> to <code>AppData</code>.</p><p><img src="https://jstnk9.github.io/jstnk9/img/analysis-devicecensus/device-7.PNG" alt="device-7.png"></p><p>The last task that the VBS does, is run <code>DeviceCensus.exe</code>, which after the execution it can load the <code>UMPDC.dll</code>.</p><p><img src="https://jstnk9.github.io/jstnk9/img/analysis-devicecensus/device-8.PNG" alt="device-8.png"></p><p>The message will appear on the screen when the DLL is loaded.</p><p><img src="https://jstnk9.github.io/jstnk9/img/analysis-devicecensus/device-9.PNG" alt="device-9.png"></p><p>The full activity on Sysmon looks like this.</p><p><img src="https://jstnk9.github.io/jstnk9/img/analysis-devicecensus/sysmon1.png" alt="sysmon-1.png"></p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="vbs-script">VBS Script<a aria-hidden="true" class="hash-link" href="#vbs-script" title="Direct link to heading">â€‹</a></h3><p>Download from gist: <a href="https://gist.github.com/jstnk9/c0f8861cf1247741812f9f0210b591ee" target="_blank" rel="noopener noreferrer">https://gist.github.com/jstnk9/c0f8861cf1247741812f9f0210b591ee</a></p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="dll">DLL<a aria-hidden="true" class="hash-link" href="#dll" title="Direct link to heading">â€‹</a></h3><p>Download from git: <a href="https://github.com/jstnk9/Research/blob/main/UMPDC.dll" target="_blank" rel="noopener noreferrer">https://github.com/jstnk9/Research/blob/main/UMPDC.dll</a></p><p>DLL code from gist: <a href="https://gist.github.com/jstnk9/034d6add18a2692e451b254472a823f9" target="_blank" rel="noopener noreferrer">https://gist.github.com/jstnk9/034d6add18a2692e451b254472a823f9</a></p><h2> Contact </h2><p><strong>Twitter</strong>: <a href="https://twitter.com/Joseliyo_Jstnk" target="_blank" rel="noopener noreferrer">https://twitter.com/Joseliyo_Jstnk</a></p><p><strong>LinkedIn</strong>: <a href="https://www.linkedin.com/in/joseluissm/" target="_blank" rel="noopener noreferrer">https://www.linkedin.com/in/joseluissm/</a></p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_xD8n"><div class="col"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/jstnk9/research/tags/threat-hunting">threat hunting</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/jstnk9/research/tags/detection">detection</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/jstnk9/research/tags/visibility">visibility</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/jstnk9/research/tags/windows-11">windows 11</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/jstnk9/research/tags/research">research</a></li></ul></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/jstnk9/research/InstallScreenSaver-SCR-files"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Â« <!-- -->Executing SCR files using desk.cpl and InstallScreenSaver API Call</div></a></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></main><div class="col col--2"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#summary" class="table-of-contents__link toc-highlight">Summary</a></li><li><a href="#testing-the-behavior" class="table-of-contents__link toc-highlight">Testing the behavior</a></li><li><a href="#poc" class="table-of-contents__link toc-highlight">PoC</a><ul><li><a href="#vbs-script" class="table-of-contents__link toc-highlight">VBS Script</a></li><li><a href="#dll" class="table-of-contents__link toc-highlight">DLL</a></li></ul></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/jstnk9/docs/intro">Home</a></li><li class="footer__item"><a class="footer__link-item" href="/jstnk9/blog">Blog</a></li></ul></div><div class="col footer__col"><div class="footer__title">Social Media</div><ul class="footer__items"><li class="footer__item"><a href="https://twitter.com/Joseliyo_Jstnk" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/joseluissm/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/jstnk9" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2023 Jstnk Website.</div></div></div></footer></div>
<script src="/jstnk9/assets/js/runtime~main.f4b21a33.js"></script>
<script src="/jstnk9/assets/js/main.f0c50aa8.js"></script>
</body>
</html>