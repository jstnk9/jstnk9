"use strict";(self.webpackChunkjstnk=self.webpackChunkjstnk||[]).push([[1547],{3905:function(e,t,a){a.d(t,{Zo:function(){return p},kt:function(){return c}});var n=a(7294);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function s(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function r(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?s(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):s(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,n,i=function(e,t){if(null==e)return{};var a,n,i={},s=Object.keys(e);for(n=0;n<s.length;n++)a=s[n],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(n=0;n<s.length;n++)a=s[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var l=n.createContext({}),u=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):r(r({},t),e)),a},p=function(e){var t=u(e.components);return n.createElement(l.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},h=n.forwardRef((function(e,t){var a=e.components,i=e.mdxType,s=e.originalType,l=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),h=u(a),c=i,g=h["".concat(l,".").concat(c)]||h[c]||m[c]||s;return a?n.createElement(g,r(r({ref:t},p),{},{components:a})):n.createElement(g,r({ref:t},p))}));function c(e,t){var a=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var s=a.length,r=new Array(s);r[0]=h;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o.mdxType="string"==typeof e?e:i,r[1]=o;for(var u=2;u<s;u++)r[u]=a[u];return n.createElement.apply(null,r)}return n.createElement.apply(null,a)}h.displayName="MDXCreateElement"},7451:function(e,t,a){a.r(t),a.d(t,{frontMatter:function(){return o},contentTitle:function(){return l},metadata:function(){return u},assets:function(){return p},toc:function(){return m},default:function(){return c}});var n=a(7462),i=a(3366),s=(a(7294),a(3905)),r=["components"],o={slug:"Sigma-Rules-as-MISP-galaxies",title:"Sigma Rules as MISP galaxies",authors:"joseliyo",tags:["threat intelligence","blue team","cybersecurity","MISP","detection engineering","sigma"]},l=void 0,u={permalink:"/jstnk9/blog/Sigma-Rules-as-MISP-galaxies",source:"@site/blog/2022-12-13-Sigma-Rules-as-MISP-galaxies/2022-12-13-Sigma-Rules-as-MISP-galaxies.md",title:"Sigma Rules as MISP galaxies",description:"A threat intelligence analyst's brief",date:"2022-12-13T00:00:00.000Z",formattedDate:"December 13, 2022",tags:[{label:"threat intelligence",permalink:"/jstnk9/blog/tags/threat-intelligence"},{label:"blue team",permalink:"/jstnk9/blog/tags/blue-team"},{label:"cybersecurity",permalink:"/jstnk9/blog/tags/cybersecurity"},{label:"MISP",permalink:"/jstnk9/blog/tags/misp"},{label:"detection engineering",permalink:"/jstnk9/blog/tags/detection-engineering"},{label:"sigma",permalink:"/jstnk9/blog/tags/sigma"}],readingTime:6.385,truncated:!0,authors:[{name:"Jose Luis S\xe1nchez Mart\xednez",title:"Security Researcher",url:"https://twitter.com/Joseliyo_Jstnk",imageURL:"https://jstnk9.github.io/jstnk9/img/profiles/1574890680450.jpeg",key:"joseliyo"}],prevItem:{title:"Sigma Rules as MISP galaxies (II)",permalink:"/jstnk9/blog/Sigma-Rules-as-MISP-galaxies-02"},nextItem:{title:"TIBER-EU and TIBER-ES - Blue Team",permalink:"/jstnk9/blog/TIBER-EU-ES-Blue-Team-Series-01"}},p={authorsImageUrls:[void 0]},m=[{value:"A threat intelligence analyst&#39;s brief",id:"a-threat-intelligence-analysts-brief",children:[],level:2},{value:"From threat intelligence w/ detection engineering",id:"from-threat-intelligence-w-detection-engineering",children:[],level:2},{value:"Add more value to your MISP events",id:"add-more-value-to-your-misp-events",children:[],level:2},{value:"How it looks?",id:"how-it-looks",children:[],level:2},{value:"Next steps",id:"next-steps",children:[],level:2}],h={toc:m};function c(e){var t=e.components,a=(0,i.Z)(e,r);return(0,s.kt)("wrapper",(0,n.Z)({},h,a,{components:t,mdxType:"MDXLayout"}),(0,s.kt)("h2",{id:"a-threat-intelligence-analysts-brief"},"A threat intelligence analyst's brief"),(0,s.kt)("p",null,"In the threat intelligence world, we are continuously analyzing threat actors and threats in general that impact different sectors. From a threat intelligence analyst's point of view, it is important to know the motivations, objectives, TTPs and the overall context of the intrusion."),(0,s.kt)("p",null,"The results produced by these analysts are usually well defined. Frequently, a report is generated with a series of sections, where some of them are usually ",(0,s.kt)("inlineCode",{parentName:"p"},"conclusions"),", ",(0,s.kt)("inlineCode",{parentName:"p"},"recommendations"),", ",(0,s.kt)("inlineCode",{parentName:"p"},"countermeasures"),".... Perhaps the least fun part for a threat intelligence analyst."),(0,s.kt)("p",null,"Also, in many cases additional products are generated and sent along with the report, such as STIX files with the analysis information, CSV files with IOCs, YARA rules and others. Another thing that most threat intelligence teams do is to dump all the information from the report into ",(0,s.kt)("inlineCode",{parentName:"p"},"MISP")," including TTPs, IOCs and context information to help categorize, filter and relate the events."),(0,s.kt)("p",null,"From a threat intelligence point of view, our work should stop there. However, when it comes to generating a good security strategy, it is important to be able to map the techniques and behaviors identified in each intrusion with different types of rules, whether they are network or behavior-based endpoint rules."),(0,s.kt)("h2",{id:"from-threat-intelligence-w-detection-engineering"},"From threat intelligence w/ detection engineering"),(0,s.kt)("p",null,"Many threat intelligence analysts are in fact in charge of creating such detection rules based on their own research or intrusion analysis. Realistically, however, this need not be the job of these analysts. "),(0,s.kt)("p",null,"Detection engineers are the responsible for creating these rules to improve detections and, in some cases, visibility. Although it is true, they sometimes need help from threat intelligence analysts to understand and have context about what they want to detect and know what is happening in the wild."),(0,s.kt)("h2",{id:"add-more-value-to-your-misp-events"},"Add more value to your MISP events"),(0,s.kt)("p",null,"As mentioned in previous points, surely as a threat intelligence analyst you usually create MISP events with IOCs and context information, such as MITRE techniques, malware families, affected countries, etc... All using MISP galaxies."),(0,s.kt)("p",null,"Adding galaxy-like sigma rules to your event would add value? Imagine analyzing an intrusion, identifying that there are multiple sigma rules that could have detected different behaviors, then adding those rules as galaxies."),(0,s.kt)("p",null,"Just for this purpose I have created a ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/jstnk9/MISP/tree/main/misp-galaxy/sigma"},"script")," that allows to generate galaxies in MISP from ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/SigmaHQ/sigma"},"Sigma Rules"),". A few months ago, I ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/jstnk9/TIBER-Cases/tree/main/scripts/sigma-taxonomy-generator"},"generated a script")," and ",(0,s.kt)("a",{parentName:"p",href:"https://twitter.com/Joseliyo_Jstnk/status/1547187670069248000"},"published")," to create taxonomies in MISP from Sigma Rules, however, I realized that there was some context information about the rule that was missing, and I had to go into the repository itself to get it. Also, it used the rule name as the taxonomy value instead of the rule title."),(0,s.kt)("p",null,"Unlike MISP taxonomies, galaxies were created just for that, they allow to add more context than taxonomies, and that is why I decided to improve the previous script to create galaxies instead of taxonomies."),(0,s.kt)("p",null,"The idea is that from a path that you indicate to the script with the place where you have stored the rules, this begins to look for them and begins to parse them to generate two types of files. The reason of doing it through a path and not from the oficial repository is because it could be the case that there are private sigma rules that have not been shared and you want to generate the galaxy in MISP in the same way."),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"Sigma-rules.json (cluster): This file must be placed inside the ",(0,s.kt)("inlineCode",{parentName:"li"},"/var/www/MISP/app/ files/misp-galaxy/clusters")," directory as it contains the Sigma-rules information itself. A part of this JSON is the one we can see below.")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "authors": [\n        "@Joseliyo_Jstnk"\n    ],\n    "category": "rules",\n    "description": "MISP galaxy cluster based on Sigma Rules.",\n    "name": "Sigma-Rules",\n    "source": "https://github.com/jstnk9/MISP/tree/main/misp-galaxy/sigma",\n    "type": "sigma-rules",\n    "uuid": "9cf7cd2e-d5f1-48c4-9909-7896ba1c96b2",\n    "values": [\n        {\n            "description": "Detects a highly relevant Antivirus alert that reports an exploitation framework",\n            "uuid": "238527ad-3c2c-4e4f-a1f6-92fd63adb864",\n            "value": "Antivirus Exploitation Framework Detection",\n            "meta": {\n                "refs": [\n                    "https://www.nextron-systems.com/2018/09/08/antivirus-event-analysis-cheat-sheet-v1-4/",\n                    "https://github.com/SigmaHQ/sigma/tree/master/rules/application/antivirus/av_exploiting.yml"\n                ],\n                "tags": [\n                    "attack.execution",\n                    "attack.t1203",\n                    "attack.command_and_control",\n                    "attack.t1219"\n                ],\n                "creation_date": "2018/09/09",\n                "filename": "av_exploiting.yml",\n                "author": "Florian Roth",\n                "level": "critical",\n                "falsepositive": [\n                    "Unlikely"\n                ],\n                "logsource.category": "antivirus",\n                "logsource.product": "No established product"\n            }\n        }\n        .......\n')),(0,s.kt)("p",null,"As can be seen in the above code fragment, most of the fields in the sigma rules are mapped. For those cases where the text ",(0,s.kt)("strong",{parentName:"p"},"Not established ","[something]")," appears, it is because the field doesn't exist in the rule."),(0,s.kt)("p",null,"Something that I didn't want to map (because I wanna think more about it) but I'm dealing with is the logic of the rule for itself. It can be difficult because the fields are dynamic."),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"Sigma-rules.json (galaxies): This file must be placed inside the ",(0,s.kt)("inlineCode",{parentName:"li"},"/var/www/MISP/app/files/misp-galaxy/galaxies")," directory and simply contains information about the galaxy, which will be required later in order to be used.")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "description": "Sigma Rules are used to detect suspicious behaviors related to threat actors, malware and tools",\n    "icon": "link",\n    "name": "Sigma-Rules",\n    "namespace": "misp",\n    "type": "sigma-rules",\n    "uuid": "9cf7cd2e-d5f1-48c4-9909-7896ba1c96b2",\n    "version": 1\n}\n')),(0,s.kt)("p",null,"If you want to learn more about how galaxies work and how to create one, you can do it here ",(0,s.kt)("a",{parentName:"p",href:"https://www.misp-project.org/2020/07/31/MISP-galaxy-101.html/"},"https://www.misp-project.org/2020/07/31/MISP-galaxy-101.html/"),"."),(0,s.kt)("h2",{id:"how-it-looks"},"How it looks?"),(0,s.kt)("p",null,"Once we have the imported galaxy in our MISP, if we navigate to it we can see something like this."),(0,s.kt)("p",null,(0,s.kt)("img",{parentName:"p",src:"https://jstnk9.github.io/jstnk9/img/blog-sigma-misp/galaxy01.png",alt:"galaxy01"})),(0,s.kt)("p",null,"The value of each item is the name of the rule, not the name of the file. This may help us in the future to do some extra implementation as well as give us much more context."),(0,s.kt)("p",null,"If we see the detail of any of these items, we can obtain the fields of the rule with the context information."),(0,s.kt)("p",null,(0,s.kt)("img",{parentName:"p",src:"https://jstnk9.github.io/jstnk9/img/blog-sigma-misp/galaxy02.png",alt:"galax02"})),(0,s.kt)("p",null,(0,s.kt)("img",{parentName:"p",src:"https://jstnk9.github.io/jstnk9/img/blog-sigma-misp/galaxy03.png",alt:"galaxy03"})),(0,s.kt)("p",null,"The more events we have stored with galaxy values on sigma rules, the more interesting the actions and statistics we can execute in the future with this information. Questions like... Which rules are detecting the most behaviors? Which logsource is giving me more information? Where do I have less visibility because I have less mapped rules? They could be answered, based on the events that are analyzed by the CTI teams in MISP."),(0,s.kt)("p",null,"An example could be to identify the Sigma rules that are detecting more behaviors, in order to improve them or to see the data sources that are giving us more detection value. This can be achieved using a script called ",(0,s.kt)("inlineCode",{parentName:"p"},"stats_report.py")," which can be found ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/MISP/PyMISP/blob/main/examples/stats_report.py"},"here"),". By running it and filtering by the dates we are interested in, we can obtain a list of sigma rules and the number of events where they appear."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},'(myenv) misp@misp:/opt/scripts/misp_statistics# python3 stats_report.py -f 2022-09-01 -u 2022-11-16 | grep sigma\nmisp-galaxy:sigma-rules="Failed Code Integrity Checks"   6\nmisp-galaxy:sigma-rules="Wow6432Node CurrentVersion Autorun Keys Modification"   4\nmisp-galaxy:sigma-rules="Creation of an Executable by an Executable"     4\nmisp-galaxy:sigma-rules="Suspicious Execution of Taskkill"       3\nmisp-galaxy:sigma-rules="Process Creation Using Sysnative Folder"        3\nmisp-galaxy:sigma-rules="Powershell Create Scheduled Task"       3\nmisp-galaxy:sigma-rules="CurrentVersion Autorun Keys Modification"       3\nmisp-galaxy:sigma-rules="Windows Processes Suspicious Parent Directory"          2\nmisp-galaxy:sigma-rules="Windows Cmd Delete File"        2\nmisp-galaxy:sigma-rules="User with Privileges Logon"     2\nmisp-galaxy:sigma-rules="Use Remove-Item to Delete File"         2\nmisp-galaxy:sigma-rules="System File Execution Location Anomaly"         2\nmisp-galaxy:sigma-rules="Rundll32 With Suspicious Parent Process"        2\nmisp-galaxy:sigma-rules="Remote Thread Creation in Suspicious Targets"   2\nmisp-galaxy:sigma-rules="Reg Add RUN Key"        2\nmisp-galaxy:sigma-rules="Python Initiated Connection"    2\nmisp-galaxy:sigma-rules="Process Start From Suspicious Folder"   2\nmisp-galaxy:sigma-rules="Execution from Suspicious Folder"       2\n')),(0,s.kt)("p",null,"In case you want to consult the information in JSON format, you can always visit the following URL to obtain it ",(0,s.kt)("a",{parentName:"p",href:"http://yourmisp.com/users/statistics/tags.json"},"http://yourmisp.com/users/statistics/tags.json"),"."),(0,s.kt)("h2",{id:"next-steps"},"Next steps"),(0,s.kt)("p",null,"MISP incorporates a very interesting functionality that allows to add ",(0,s.kt)("strong",{parentName:"p"},"relationships")," to several clusters. That is why, in future updates, I would like to add different relationships to the Sigma galaxy such as MITRE Techniques, Software, Groups, etc."),(0,s.kt)("p",null,"More information about relationships and galaxies here: ",(0,s.kt)("a",{parentName:"p",href:"https://www.misp-project.org/misp-training/a.10-galaxy-2.0.pdf"},"https://www.misp-project.org/misp-training/a.10-galaxy-2.0.pdf")),(0,s.kt)("h2",null," Contact "),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Twitter"),": ",(0,s.kt)("a",{parentName:"p",href:"https://twitter.com/Joseliyo_Jstnk"},"https://twitter.com/Joseliyo_Jstnk")),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"LinkedIn"),": ",(0,s.kt)("a",{parentName:"p",href:"https://www.linkedin.com/in/joseluissm/"},"https://www.linkedin.com/in/joseluissm/")),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"GitHub Project"),": ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/jstnk9/MISP"},"https://github.com/jstnk9/MISP")),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Mastodon"),": ",(0,s.kt)("inlineCode",{parentName:"p"},"@Joseliyo_Jstnk@infosec.exchange")),(0,s.kt)("h2",null," References "),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("a",{parentName:"li",href:"https://www.misp-project.org/misp-training/a.10-galaxy-2.0.pdf"},"https://www.misp-project.org/misp-training/a.10-galaxy-2.0.pdf")),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("a",{parentName:"li",href:"https://www.vanimpe.eu/2019/07/13/generating-misp-data-statistical-reports/"},"https://www.vanimpe.eu/2019/07/13/generating-misp-data-statistical-reports/")),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("a",{parentName:"li",href:"https://github.com/SigmaHQ/sigma"},"https://github.com/SigmaHQ/sigma")),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("a",{parentName:"li",href:"https://github.com/MISP/misp-galaxy"},"https://github.com/MISP/misp-galaxy")),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("a",{parentName:"li",href:"https://www.misp-project.org/galaxy.html"},"https://www.misp-project.org/galaxy.html"))))}c.isMDXComponent=!0}}]);