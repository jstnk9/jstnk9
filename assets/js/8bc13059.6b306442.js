"use strict";(self.webpackChunkjstnk=self.webpackChunkjstnk||[]).push([[7045],{3905:function(e,t,a){a.d(t,{Zo:function(){return c},kt:function(){return p}});var n=a(7294);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,i=function(e,t){if(null==e)return{};var a,n,i={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var s=n.createContext({}),u=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},c=function(e){var t=u(e.components);return n.createElement(s.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},h=n.forwardRef((function(e,t){var a=e.components,i=e.mdxType,r=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),h=u(a),p=i,d=h["".concat(s,".").concat(p)]||h[p]||m[p]||r;return a?n.createElement(d,o(o({ref:t},c),{},{components:a})):n.createElement(d,o({ref:t},c))}));function p(e,t){var a=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=a.length,o=new Array(r);o[0]=h;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:i,o[1]=l;for(var u=2;u<r;u++)o[u]=a[u];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}h.displayName="MDXCreateElement"},352:function(e,t,a){a.r(t),a.d(t,{frontMatter:function(){return l},contentTitle:function(){return s},metadata:function(){return u},assets:function(){return c},toc:function(){return m},default:function(){return p}});var n=a(7462),i=a(3366),r=(a(7294),a(3905)),o=["components"],l={slug:"MISP-object-creator-with-Virustotal-and-Sigma",title:"MISP object creator with VirusTotal and Sigma Galaxies",authors:"joseliyo",tags:["threat intelligence","blue team","cybersecurity","MISP","detection engineering","sigma","virustotal","threat hunting"]},s=void 0,u={permalink:"/jstnk9/blog/MISP-object-creator-with-Virustotal-and-Sigma",source:"@site/blog/2023-06-14-MISP-object-creator-with-Virustotal-and-Sigma/2023-06-14-MISP-object-creator-with-Virustotal-and-Sigma.md",title:"MISP object creator with VirusTotal and Sigma Galaxies",description:"TL;DR\u200b",date:"2023-06-14T00:00:00.000Z",formattedDate:"June 14, 2023",tags:[{label:"threat intelligence",permalink:"/jstnk9/blog/tags/threat-intelligence"},{label:"blue team",permalink:"/jstnk9/blog/tags/blue-team"},{label:"cybersecurity",permalink:"/jstnk9/blog/tags/cybersecurity"},{label:"MISP",permalink:"/jstnk9/blog/tags/misp"},{label:"detection engineering",permalink:"/jstnk9/blog/tags/detection-engineering"},{label:"sigma",permalink:"/jstnk9/blog/tags/sigma"},{label:"virustotal",permalink:"/jstnk9/blog/tags/virustotal"},{label:"threat hunting",permalink:"/jstnk9/blog/tags/threat-hunting"}],readingTime:5.77,truncated:!0,authors:[{name:"Jose Luis S\xe1nchez Mart\xednez",title:"Security Researcher",url:"https://twitter.com/Joseliyo_Jstnk",imageURL:"https://jstnk9.github.io/jstnk9/img/profiles/1574890680450.jpeg",key:"joseliyo"}],nextItem:{title:"Sigma Rules as MISP galaxies (II)",permalink:"/jstnk9/blog/Sigma-Rules-as-MISP-galaxies-02"}},c={authorsImageUrls:[void 0]},m=[{value:"TL;DR\u200b",id:"tldr",children:[],level:2},{value:"Object creator",id:"object-creator",children:[{value:"Sigma rules from VirusTotal",id:"sigma-rules-from-virustotal",children:[],level:3},{value:"MITRE Techniques from VirusTotal",id:"mitre-techniques-from-virustotal",children:[],level:3},{value:"Event Creation",id:"event-creation",children:[],level:3},{value:"GitHub Repo",id:"github-repo",children:[],level:3}],level:2}],h={toc:m};function p(e){var t=e.components,a=(0,i.Z)(e,o);return(0,r.kt)("wrapper",(0,n.Z)({},h,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"tldr"},"TL;DR\u200b"),(0,r.kt)("p",null,"I have created a new script to automate the ingestion of IOCs in MISP in object format. This script also automatically consumes information from VirusTotal to enrich the IOCs in case of exist in VT. However, the most interesting thing about this script is that it is able to automatically obtain the Sigma rules and MITRE techniques of the IOCs that we want to store in MISP, and add this information as Galaxies."),(0,r.kt)("p",null,"The stored galaxies are at the event level and at the object level, i.e. the event will have the total number of galaxies related to Sigma rules and MITRE techniques. Each object will have only the galaxies related to its behavior."),(0,r.kt)("p",null,"All you need to use the script is a VT API Key and to have the Sigma and MITRE galaxies in your instance. Since 2022-11-28 the Sigma galaxy ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/MISP/misp-galaxy/blob/main/clusters/sigma-rules.json"},"is embedded")," in the default version of MISP. In case you don't have it, I recommend you to read ",(0,r.kt)("a",{parentName:"p",href:"https://jstnk9.github.io/jstnk9/blog/Sigma-Rules-as-MISP-galaxies"},"this blog")," and ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/jstnk9/MISP/tree/main/misp-galaxy/sigma"},"use the script I made")," to create the sigma rules galaxy."),(0,r.kt)("h2",{id:"object-creator"},"Object creator"),(0,r.kt)("p",null,"Object creator is a python script that helps you to add IOCs (in object format) in your MISP with extra information and galaxies automatically. The information is retrieved from VirusTotal using the API Key. If the IOC is in VT, the information extracted is as follows:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Files",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Sha256"),(0,r.kt)("li",{parentName:"ul"},"MD5"),(0,r.kt)("li",{parentName:"ul"},"Sha1"),(0,r.kt)("li",{parentName:"ul"},"ssdeep"),(0,r.kt)("li",{parentName:"ul"},"vhash"),(0,r.kt)("li",{parentName:"ul"},"tlsh"),(0,r.kt)("li",{parentName:"ul"},"mimetype"),(0,r.kt)("li",{parentName:"ul"},"filenames"),(0,r.kt)("li",{parentName:"ul"},"magic"),(0,r.kt)("li",{parentName:"ul"},"MITRE Techniques as MISP Galaxies"),(0,r.kt)("li",{parentName:"ul"},"Sigma rules as MISP Galaxies"))),(0,r.kt)("li",{parentName:"ul"},"IPs",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"IP"),(0,r.kt)("li",{parentName:"ul"},"ASN"),(0,r.kt)("li",{parentName:"ul"},"Country code"),(0,r.kt)("li",{parentName:"ul"},"network"),(0,r.kt)("li",{parentName:"ul"},"ASN Owner"))),(0,r.kt)("li",{parentName:"ul"},"Domains",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Domain"),(0,r.kt)("li",{parentName:"ul"},"Registration date"),(0,r.kt)("li",{parentName:"ul"},"Resolutions"))),(0,r.kt)("li",{parentName:"ul"},"URLs ",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"URL"),(0,r.kt)("li",{parentName:"ul"},"Host"),(0,r.kt)("li",{parentName:"ul"},"Port"),(0,r.kt)("li",{parentName:"ul"},"Resource Path"),(0,r.kt)("li",{parentName:"ul"},"Query string"))),(0,r.kt)("li",{parentName:"ul"},"Event",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"All the MITRE Techniques extracted from the files stored in the MISP event"),(0,r.kt)("li",{parentName:"ul"},"All the Sigma rules extracted from the files stored in the MISP event")))),(0,r.kt)("p",null,"Nowadays not all VirusTotal samples have MITRE and Sigma Rules techniques. In the case of Sigma Rules, it is sometimes difficult to obtain results, especially depending on the file type. In general, binaries usually get good results with the associated sigma rules, but some office documents do not always get the expected results."),(0,r.kt)("p",null,"It is important to mention that the Sigma rules that VirusTotal has at its disposal are essentially those from the public Sigma GitHub. They also have other sigma rules from vendors related to Sandboxing. How VirusTotal relates sample behaviors to Sigma rules is unknown."),(0,r.kt)("h3",{id:"sigma-rules-from-virustotal"},"Sigma rules from VirusTotal"),(0,r.kt)("p",null,"To obtain the Sigma rules information from a file, the ",(0,r.kt)("a",{parentName:"p",href:"https://developers.virustotal.com/reference/file-info"},"endpoint")," of ",(0,r.kt)("inlineCode",{parentName:"p"},"files")," is queried. The returned object contains a key called ",(0,r.kt)("inlineCode",{parentName:"p"},"sigma_analysis_results")," which stores information about the sigma rules that could be related."),(0,r.kt)("p",null,"Another associated value information is the log where the match could be obtained in the ",(0,r.kt)("inlineCode",{parentName:"p"},"match_context")," key. Currently nothing is being done with that value in this script, however it is likely that some of the information it incorporates will be added in some objects :-)."),(0,r.kt)("p",null,"The following object is an example obtained through the sample ",(0,r.kt)("inlineCode",{parentName:"p"},"1641c9494dd3eabd7131add274804d83a308eecb241a56931ce045412c32f0a26f")," in VirusTotal."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "rule_title": "Suspicious Schtasks From Env Var Folder",\n    "rule_source": "Sigma Integrated Rule Set (GitHub)",\n    "match_context": [\n    {\n        "values": {\n        "TerminalSessionId": "1",\n        "ProcessGuid": "{C784477D-A7ED-643C-F905-000000004400}",\n        "ProcessId": "3144",\n        "Product": "Microsoft\\\\xae Windows\\\\xae Operating System",\n        "Description": "Task Scheduler Configuration Tool",\n        "Company": "Microsoft Corporation",\n        "ParentProcessGuid": "{C784477D-A7EC-643C-F505-000000004400}",\n        "User": "DESKTOP-B0T93D6\\\\george",\n        "Hashes": "MD5=838D346D1D28F00783B7A6C6BD03A0DA,SHA256=8BE433049CCC271F04A8E625E9FB9BD3BCF15B4EDEB63497C00BD9CE1CD5C50E,IMPHASH=7EE4BC5589713B3470B8A950256E2E69",\n        "OriginalFileName": "schtasks.exe",\n        "ParentImage": "C:\\\\Windows\\\\System32\\\\cmd.exe",\n        "FileVersion": "10.0.17134.1 (WinBuild.160101.0800)",\n        "ParentProcessId": "4524",\n        "CurrentDirectory": "C:\\\\Users\\\\george\\\\Desktop\\\\",\n        "CommandLine": "schtasks  /create /f /sc onlogon /rl highest /tn \\"t-launcher\\" /tr \'\\"C:\\\\Users\\\\george\\\\AppData\\\\Roaming\\\\t-launcher.exe\\"\' ",\n        "EventID": "1",\n        "LogonGuid": "C784477D-1D0C-6407-0BA7-030000000000",\n        "LogonId": "239371",\n        "Image": "C:\\\\Windows\\\\System32\\\\schtasks.exe",\n        "IntegrityLevel": "High",\n        "ParentCommandLine": "\\"C:\\\\Windows\\\\System32\\\\cmd.exe\\" /c schtasks /create /f /sc onlogon /rl highest /tn \\"t-launcher\\" /tr \'\\"C:\\\\Users\\\\george\\\\AppData\\\\Roaming\\\\t-launcher.exe\\"\' & exit",\n        "UtcTime": "1681696749",\n        "RuleName": "-"\n        }\n    }\n    ],\n    "rule_level": "high",\n    "rule_id": "0533322c5c44794b71e761cd351a2459aad6e21ae95c9543d4c9fdb3c8fde6c4",\n    "rule_author": "Florian Roth (Nextron Systems)",\n    "rule_description": "Detects Schtask creations that point to a suspicious folder or an environment variable often used by malware"\n}\n')),(0,r.kt)("p",null,"As you can see, among the information obtained is the ",(0,r.kt)("inlineCode",{parentName:"p"},"id")," of the rule, ",(0,r.kt)("inlineCode",{parentName:"p"},"author"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"title")," and other information. In this case, the necessary information would be the name of the rule, which is the same that will be previously stored in the Sigma galaxy."),(0,r.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"INFORMATION")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"In case the sigma rule identified in the sample through VirusTotal is not found in the public Sigma GitHub, such rule will be added as a ",(0,r.kt)("inlineCode",{parentName:"p"},"Tag")," and not as a ",(0,r.kt)("inlineCode",{parentName:"p"},"Galaxy"),", since it will not be previously stored."))),(0,r.kt)("p",null,"The sigma rules will be added in two different ways. The first one is globally in the event. For example, if we want to add 5 IOCs in a MISP event and the total of sigma rules identified in those 5 samples are 17 rules, 17 new galaxies will be created in the MISP event. On the other hand, for each of the 5 IOCs an object is generated as an attribute, and each object will have related sigma rules that have been seen in its behavior. In this way, the event and each object are characterized globally."),(0,r.kt)("h3",{id:"mitre-techniques-from-virustotal"},"MITRE Techniques from VirusTotal"),(0,r.kt)("p",null,"The same way that the sigma rules are obtained is done with the MITRE techniques. In this case the ",(0,r.kt)("a",{parentName:"p",href:"https://developers.virustotal.com/reference/get-all-behavior-reports-for-a-file"},"endpoint")," is different, since information is consumed from the behavior, being ",(0,r.kt)("inlineCode",{parentName:"p"},"behaviour_mitre_trees"),"."),(0,r.kt)("p",null,"Currently the information from the ",(0,r.kt)("inlineCode",{parentName:"p"},"Zenbox")," sandbox is consumed, but it is planned to add the value of other sandboxes. The reason for choosing ",(0,r.kt)("inlineCode",{parentName:"p"},"Zenbox")," is because it is usually the sandbox that obtains more results from the analyzed samples."),(0,r.kt)("p",null,"An example of a response obtained from VirusTotal could be as follows."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'"mitre_attack_techniques": [\n    {\n        "signature_description": "Creates files inside the user directory",\n        "id": "T1036",\n        "severity": "IMPACT_SEVERITY_INFO"\n    },\n    {\n        "signature_description": "Sample is packed with UPX",\n        "id": "T1027.002",\n        "severity": "IMPACT_SEVERITY_INFO"\n    },\n    {\n        "signature_description": "PE file has section (not .text) which is very likely to contain packed code (zlib compression ratio < 0.011)",\n        "id": "T1027.002",\n        "severity": "IMPACT_SEVERITY_INFO"\n    }\n]\n')),(0,r.kt)("h3",{id:"event-creation"},"Event Creation"),(0,r.kt)("p",null,"At a high level, the process to create a new event in MISP based on the IOCs you want to store is as follows."),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://jstnk9.github.io/jstnk9/img/blog-object-creator/graph.png",alt:"process"})),(0,r.kt)("p",null,"As stated above, galaxies are stored both in the objects and in the event itself. This will allow us to identify the exact sigma rules and techniques used by a specific sample."),(0,r.kt)("p",null,"An example of an object created with the information extracted from VirusTotal to enrich it and with the corresponding galaxies would be the following."),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://jstnk9.github.io/jstnk9/img/blog-object-creator/object_created.png",alt:"objectimage"})),(0,r.kt)("p",null,"As for the event, as explained it will contain all the galaxies of all the objects. An example of an event created from the ingestion of 7 IOCs is the following."),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://jstnk9.github.io/jstnk9/img/blog-object-creator/event.png",alt:"eventcreated"})),(0,r.kt)("h3",{id:"github-repo"},"GitHub Repo"),(0,r.kt)("p",null,"If you want to use this script and get more information about how to use it, please go to the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/jstnk9/MISP/tree/main/object-creator/"},"public GitHub")," repo."),(0,r.kt)("p",null,"I have in mind to improve this script. During the next months I will be updating the GitHub repo."),(0,r.kt)("h2",null," Contact "),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Twitter"),": ",(0,r.kt)("a",{parentName:"p",href:"https://twitter.com/Joseliyo_Jstnk"},"https://twitter.com/Joseliyo_Jstnk")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"LinkedIn"),": ",(0,r.kt)("a",{parentName:"p",href:"https://www.linkedin.com/in/joseluissm/"},"https://www.linkedin.com/in/joseluissm/")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"GitHub Project"),": ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/jstnk9/MISP/tree/main/object-creator"},"https://github.com/jstnk9/MISP/tree/main/object-creator")))}p.isMDXComponent=!0}}]);