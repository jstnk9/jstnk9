"use strict";(self.webpackChunkjstnk=self.webpackChunkjstnk||[]).push([[9826],{3905:function(e,t,a){a.d(t,{Zo:function(){return h},kt:function(){return g}});var i=a(7294);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,i)}return a}function s(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,i,n=function(e,t){if(null==e)return{};var a,i,n={},r=Object.keys(e);for(i=0;i<r.length;i++)a=r[i],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(i=0;i<r.length;i++)a=r[i],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var o=i.createContext({}),p=function(e){var t=i.useContext(o),a=t;return e&&(a="function"==typeof e?e(t):s(s({},t),e)),a},h=function(e){var t=p(e.components);return i.createElement(o.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},u=i.forwardRef((function(e,t){var a=e.components,n=e.mdxType,r=e.originalType,o=e.parentName,h=l(e,["components","mdxType","originalType","parentName"]),u=p(a),g=n,c=u["".concat(o,".").concat(g)]||u[g]||m[g]||r;return a?i.createElement(c,s(s({ref:t},h),{},{components:a})):i.createElement(c,s({ref:t},h))}));function g(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var r=a.length,s=new Array(r);s[0]=u;var l={};for(var o in t)hasOwnProperty.call(t,o)&&(l[o]=t[o]);l.originalType=e,l.mdxType="string"==typeof e?e:n,s[1]=l;for(var p=2;p<r;p++)s[p]=a[p];return i.createElement.apply(null,s)}return i.createElement.apply(null,a)}u.displayName="MDXCreateElement"},6575:function(e,t,a){a.r(t),a.d(t,{frontMatter:function(){return l},contentTitle:function(){return o},metadata:function(){return p},assets:function(){return h},toc:function(){return m},default:function(){return g}});var i=a(7462),n=a(3366),r=(a(7294),a(3905)),s=["components"],l={slug:"Sigma-Rules-as-MISP-galaxies-02",title:"Sigma Rules as MISP galaxies (II)",authors:"joseliyo",tags:["threat intelligence","blue team","cybersecurity","MISP","detection engineering","sigma"]},o=void 0,p={permalink:"/jstnk9/blog/Sigma-Rules-as-MISP-galaxies-02",source:"@site/blog/2023-01-11-Sigma-Rules-as-MISP-galaxies-02/2023-01-11-Sigma-Rules-as-MISP-galaxies-02.md",title:"Sigma Rules as MISP galaxies (II)",description:"Before reading this blog I recommend you to read the first part of it//jstnk9.github.io/jstnk9/blog/Sigma-Rules-as-MISP-galaxies",date:"2023-01-11T00:00:00.000Z",formattedDate:"January 11, 2023",tags:[{label:"threat intelligence",permalink:"/jstnk9/blog/tags/threat-intelligence"},{label:"blue team",permalink:"/jstnk9/blog/tags/blue-team"},{label:"cybersecurity",permalink:"/jstnk9/blog/tags/cybersecurity"},{label:"MISP",permalink:"/jstnk9/blog/tags/misp"},{label:"detection engineering",permalink:"/jstnk9/blog/tags/detection-engineering"},{label:"sigma",permalink:"/jstnk9/blog/tags/sigma"}],readingTime:3.055,truncated:!0,authors:[{name:"Jose Luis S\xe1nchez Mart\xednez",title:"Security Researcher",url:"https://twitter.com/Joseliyo_Jstnk",imageURL:"https://jstnk9.github.io/jstnk9/img/profiles/1574890680450.jpeg",key:"joseliyo"}],prevItem:{title:"MISP object creator with VirusTotal and Sigma Galaxies",permalink:"/jstnk9/blog/MISP-object-creator-with-Virustotal-and-Sigma"},nextItem:{title:"Sigma Rules as MISP galaxies",permalink:"/jstnk9/blog/Sigma-Rules-as-MISP-galaxies"}},h={authorsImageUrls:[void 0]},m=[{value:"Version 2.0",id:"version-20",children:[],level:2},{value:"ATT&amp;CK MITRE Galaxy",id:"attck-mitre-galaxy",children:[],level:2},{value:"Generate the galaxy",id:"generate-the-galaxy",children:[],level:2}],u={toc:m};function g(e){var t=e.components,a=(0,n.Z)(e,s);return(0,r.kt)("wrapper",(0,i.Z)({},u,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"ICYMI")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"Before reading this blog I recommend you to read the first part of it: ",(0,r.kt)("a",{parentName:"p",href:"https://jstnk9.github.io/jstnk9/blog/Sigma-Rules-as-MISP-galaxies"},"https://jstnk9.github.io/jstnk9/blog/Sigma-Rules-as-MISP-galaxies")),(0,r.kt)("p",{parentName:"div"},"MISP has already added this galaxy to its ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/MISP/misp-galaxy"},"repository"),"."),(0,r.kt)("p",{parentName:"div"},"Cluster: ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/MISP/misp-galaxy/blob/main/clusters/sigma-rules.json"},"https://github.com/MISP/misp-galaxy/blob/main/clusters/sigma-rules.json")),(0,r.kt)("p",{parentName:"div"},"Galaxy: ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/MISP/misp-galaxy/blob/main/galaxies/sigma-rules.json"},"https://github.com/MISP/misp-galaxy/blob/main/galaxies/sigma-rules.json")))),(0,r.kt)("h2",{id:"version-20"},"Version 2.0"),(0,r.kt)("p",null,"During the last weeks, I have been working on the script to improve it and to allow in this new version that I have recently published, the possibility to add relations in the galaxy with another already existing MITRE ATT&CK. This, among other things allows to know in a quick and visual way which sigma rule is related to which technique within MISP. "),(0,r.kt)("p",null,"Suppose you have an event in MISP that is mapped to 5 MITRE ATT&CK techniques. Now, by clicking on those techniques and expanding the relationships, you will be able to see if there is any sigma rule that can cover any behavior of the expanded technique."),(0,r.kt)("h2",{id:"attck-mitre-galaxy"},"ATT&CK MITRE Galaxy"),(0,r.kt)("p",null,"If you have MISP deployed, you probably use the MITRE ATT&CK galaxy. That galaxy is found by default when you install MISP, as is the Sigma galaxy now. You can find it here ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/MISP/misp-galaxy/blob/main/clusters/mitre-attack-pattern.json"},"mitre-attack-pattern.json"),"."),(0,r.kt)("p",null,"If we access to any cluster of our galaxy, there is a button where it says ",(0,r.kt)("inlineCode",{parentName:"p"},"Toggle Cluster relationships"),", clicking on it, we can see the relationships that this cluster has."),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://jstnk9.github.io/jstnk9/img/blog-sigma-misp2/showrelation.png",alt:"galaxy01"})),(0,r.kt)("p",null,"Subsequently, the drop-down list will open with the relationships that the sigma rule has with the MITRE techniques, in case there is any relationship."),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://jstnk9.github.io/jstnk9/img/blog-sigma-misp2/1relation.jpg",alt:"galaxy02"})),(0,r.kt)("p",null,"On the contrary, if we access the cluster of a MITRE ATT&CK technique, we can see all the relationships it has, such as tools, MITRE mitigations and also, our sigma rules."),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://jstnk9.github.io/jstnk9/img/blog-sigma-misp2/2relation.jpg",alt:"galaxy03"})),(0,r.kt)("h2",{id:"generate-the-galaxy"},"Generate the galaxy"),(0,r.kt)("p",null,"To generate the galaxy is very simple. The first thing to do is to clone the repository and install the requirements from the file ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/jstnk9/MISP/blob/main/misp-galaxy/sigma/requirements.txt"},(0,r.kt)("inlineCode",{parentName:"a"},"requirements.txt")),". It is important to mention that ",(0,r.kt)("inlineCode",{parentName:"p"},"python3")," is required to run the script."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"pip3 install -r requirements\n")),(0,r.kt)("p",null,"Once installed, something new in this 2.0 version is the file ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/jstnk9/MISP/blob/main/misp-galaxy/sigma/config.ini"},(0,r.kt)("inlineCode",{parentName:"a"},"config.ini")),". The inclusion of this file is necessary so that the user who is going to execute the script, indicates the path where the galaxy related to MITRE ATT&CK is located. Generally, the directory will be the one indicated in this file, however, if the installation was done outside ",(0,r.kt)("inlineCode",{parentName:"p"},"/var/www/MISP"),", it is important that you modify it."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"[MISP]\ncluster_path = /var/www/MISP/app/files/misp-galaxy/clusters/\nmitre_attack_cluster = mitre-attack-pattern.json\n")),(0,r.kt)("p",null,"The content of the ",(0,r.kt)("inlineCode",{parentName:"p"},"cluster_path")," variable contains the path where the MISP clusters are located. On the other hand, the content of the variable ",(0,r.kt)("inlineCode",{parentName:"p"},"mitre_attack_cluster")," is the ATT&CK MITRE cluster with the MITRE techniques and tactics."),(0,r.kt)("p",null,"Once we make sure that the configuration file contains the correct information, we will need to have cloned the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/SigmaHQ/sigma"},"Sigma Rules repository"),". If instead of using the Sigma Rules repository we want to use our own sigma rules, we can also do this (just change the path in the ",(0,r.kt)("inlineCode",{parentName:"p"},"-p")," parameter). In this case, we will use the original repository and run the following command to generate the galaxy and the cluster."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"python3 sigma-to-galaxy.py -r -p /opt/sigma/rules\n")),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"-p")," parameter is used to indicate the path where our sigma rules are located. The ",(0,r.kt)("inlineCode",{parentName:"p"},"-r")," parameter indicates that it is executed recursively, that is, if within the ",(0,r.kt)("inlineCode",{parentName:"p"},"/opt/sigma/rules")," directory there are subfolders with more rules, these will be incorporated."),(0,r.kt)("p",null,"Finished, we will obtain the two files of the galaxies and clusters that we will have to put in their corresponding folder, as it was indicated in the ",(0,r.kt)("a",{parentName:"p",href:"https://jstnk9.github.io/jstnk9/blog/Sigma-Rules-as-MISP-galaxies"},"first blog"),"."),(0,r.kt)("h2",null," Contact "),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Twitter"),": ",(0,r.kt)("a",{parentName:"p",href:"https://twitter.com/Joseliyo_Jstnk"},"https://twitter.com/Joseliyo_Jstnk")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"LinkedIn"),": ",(0,r.kt)("a",{parentName:"p",href:"https://www.linkedin.com/in/joseluissm/"},"https://www.linkedin.com/in/joseluissm/")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"GitHub Project"),": ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/jstnk9/MISP"},"https://github.com/jstnk9/MISP")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Mastodon"),": ",(0,r.kt)("inlineCode",{parentName:"p"},"@Joseliyo_Jstnk@infosec.exchange")),(0,r.kt)("h2",null," References "),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://www.misp-project.org/misp-training/a.10-galaxy-2.0.pdf"},"https://www.misp-project.org/misp-training/a.10-galaxy-2.0.pdf")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://twitter.com/adulau/status/1611386536225902596"},"https://twitter.com/adulau/status/1611386536225902596")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/SigmaHQ/sigma"},"https://github.com/SigmaHQ/sigma")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/MISP/misp-galaxy"},"https://github.com/MISP/misp-galaxy")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/jstnk9/MISP/tree/main/misp-galaxy/sigma"},"https://github.com/jstnk9/MISP/tree/main/misp-galaxy/sigma")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://www.misp-project.org/galaxy.html"},"https://www.misp-project.org/galaxy.html")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://jstnk9.github.io/jstnk9/blog/Sigma-Rules-as-MISP-galaxies"},"https://jstnk9.github.io/jstnk9/blog/Sigma-Rules-as-MISP-galaxies"))))}g.isMDXComponent=!0}}]);