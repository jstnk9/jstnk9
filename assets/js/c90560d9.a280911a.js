"use strict";(self.webpackChunkjstnk=self.webpackChunkjstnk||[]).push([[641],{3905:function(e,t,i){i.d(t,{Zo:function(){return h},kt:function(){return p}});var n=i(7294);function a(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function o(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function r(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?o(Object(i),!0).forEach((function(t){a(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):o(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function s(e,t){if(null==e)return{};var i,n,a=function(e,t){if(null==e)return{};var i,n,a={},o=Object.keys(e);for(n=0;n<o.length;n++)i=o[n],t.indexOf(i)>=0||(a[i]=e[i]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)i=o[n],t.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(a[i]=e[i])}return a}var l=n.createContext({}),c=function(e){var t=n.useContext(l),i=t;return e&&(i="function"==typeof e?e(t):r(r({},t),e)),i},h=function(e){var t=c(e.components);return n.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},u=n.forwardRef((function(e,t){var i=e.components,a=e.mdxType,o=e.originalType,l=e.parentName,h=s(e,["components","mdxType","originalType","parentName"]),u=c(i),p=a,m=u["".concat(l,".").concat(p)]||u[p]||d[p]||o;return i?n.createElement(m,r(r({ref:t},h),{},{components:i})):n.createElement(m,r({ref:t},h))}));function p(e,t){var i=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=i.length,r=new Array(o);r[0]=u;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:a,r[1]=s;for(var c=2;c<o;c++)r[c]=i[c];return n.createElement.apply(null,r)}return n.createElement.apply(null,i)}u.displayName="MDXCreateElement"},1819:function(e,t,i){i.r(t),i.d(t,{frontMatter:function(){return s},contentTitle:function(){return l},metadata:function(){return c},assets:function(){return h},toc:function(){return d},default:function(){return p}});var n=i(7462),a=i(3366),o=(i(7294),i(3905)),r=["components"],s={slug:"Indicator-life-cycle-applied-to-threat-hunting",title:"Indicator life cycle applied to threat hunting",authors:"joseliyo",tags:["threat intelligence","threat huting","cybersecurity","process","life-cycle"]},l=void 0,c={permalink:"/jstnk9/blog/Indicator-life-cycle-applied-to-threat-hunting",source:"@site/blog/2021-04-12-Indicator-life-cycle-applied-to-threat-hunting/2021-04-12-Indicator-life-cycle-applied-to-threat-hunting.md",title:"Indicator life cycle applied to threat hunting",description:"TL;DR",date:"2021-04-12T00:00:00.000Z",formattedDate:"April 12, 2021",tags:[{label:"threat intelligence",permalink:"/jstnk9/blog/tags/threat-intelligence"},{label:"threat huting",permalink:"/jstnk9/blog/tags/threat-huting"},{label:"cybersecurity",permalink:"/jstnk9/blog/tags/cybersecurity"},{label:"process",permalink:"/jstnk9/blog/tags/process"},{label:"life-cycle",permalink:"/jstnk9/blog/tags/life-cycle"}],readingTime:8.87,truncated:!0,authors:[{name:"Jose Luis S\xe1nchez Mart\xednez",title:"Security Researcher",url:"https://twitter.com/Joseliyo_Jstnk",imageURL:"https://jstnk9.github.io/jstnk9/img/profiles/1574890680450.jpeg",key:"joseliyo"}],prevItem:{title:"Threat modeling and strategic vision of risks",permalink:"/jstnk9/blog/Threat-modeling-and-strategic-vision-of-risks"},nextItem:{title:"TypeRef Hasher- The imphash solution for samples in .NET",permalink:"/jstnk9/blog/TypeRef Hasher-The-imphash-solution-for-samples-in-NET"}},h={authorsImageUrls:[void 0]},d=[{value:"TL;DR",id:"tldr",children:[],level:2},{value:"Indicator life cycle",id:"indicator-life-cycle",children:[{value:"From revealed to mature",id:"from-revealed-to-mature",children:[],level:3},{value:"From mature to utilized",id:"from-mature-to-utilized",children:[],level:3},{value:"From utilized to revealed",id:"from-utilized-to-revealed",children:[],level:3}],level:2},{value:"Applying the cycle in threat hunting activities",id:"applying-the-cycle-in-threat-hunting-activities",children:[],level:2},{value:"Case study",id:"case-study",children:[{value:"#1 \u2014 Hypothesis generation",id:"1--hypothesis-generation",children:[],level:3},{value:"#2 - Hunting",id:"2---hunting",children:[],level:3},{value:"#3 - Revealed to mature",id:"3---revealed-to-mature",children:[],level:3},{value:"#4 - Mature to utilized",id:"4---mature-to-utilized",children:[],level:3},{value:"#5 - Utilized to revealed",id:"5---utilized-to-revealed",children:[],level:3},{value:"#6 \u2014 Discovery",id:"6--discovery",children:[],level:3},{value:"#7 \u2014 Report and enrichment",id:"7--report-and-enrichment",children:[],level:3}],level:2}],u={toc:d};function p(e){var t=e.components,i=(0,a.Z)(e,r);return(0,o.kt)("wrapper",(0,n.Z)({},u,i,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"tldr"},"TL;DR"),(0,o.kt)("p",null,"The threat hunting process that currently exists can be used in parallel with another process called indicator life cycle."),(0,o.kt)("p",null,"Both cycles are based on the same, aiming at proactive detection of threats and behaviors in corporate networks, leaving aside the reactive approach which is increasingly being avoided."),(0,o.kt)("p",null,"This is because traditional incident response processes have a methodology based on working on an event that has taken place, whereas the indicator lifecycle and threat hunting process work from the perspective of working to prevent something from happening."),(0,o.kt)("p",null,"During this blog I will explain the indicator lifecycle and how it can be used in parallel with the threat hunting process, also presenting a case study at the end."),(0,o.kt)("h2",{id:"indicator-life-cycle"},"Indicator life cycle"),(0,o.kt)("p",null,"Indicator life cycle is not intended to define how long an indicator is valid or not, since this depends on a large number of variables not controlled by analysts."),(0,o.kt)("p",null,"The objective of this cycle is to proactively use certain indicators to mature them and then automate new searches that may reveal other related indicators."),(0,o.kt)("p",null,"Although the concept may initially seem a bit confusing, this cycle makes a lot of sense to apply it to threat hunting activities, as it is in these activities that maximum value can be derived."),(0,o.kt)("p",null,"Before going into detail about the explanation of this cycle, it is important to know what kind of indicators are valid for these operations, because nowadays, the term indicator is too ambiguous, not everyone understands the same thing by indicator."),(0,o.kt)("p",null,"Personally, I find the three differentiated concepts presented in the ",(0,o.kt)("a",{target:"_blank",href:"https://www.lockheedmartin.com/content/dam/lockheed-martin/rms/documents/cyber/LM-White-Paper-Intel-Driven-Defense.pdf"}," Lockheed Martin Corporation ")," paper very useful. These concepts are as follows."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("strong",{parentName:"p"},"Atomic indicators"),": Atomic indicators are obtained based on the context of an intrusion that has taken place. The \u201cproblem\u201d with this type of indicators is that they do not have to be exclusive activity of a specific adversary, i.e. an atomic indicator can be identified in several intrusions of different adversaries. Some examples of these indicators are IP addresses, domains, the name of a path of a domain\u2026")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("strong",{parentName:"p"},"Computed indicators"),": The concept of a calculated indicator is quite confusing. These indicators are developed from attributes that occur in an incident. For example, a hash of a file that has been seen in an incident can be calculated, so its MD5, SHA1\u2026 are calculated indicators. Another example could be a regular expression, which we can develop to detect something specific.")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("strong",{parentName:"p"},"behavioral indicators"),": These indicators are composed of a combination of the two types described above. For example, within this category we could state the following; \u201cAdversaries established a C&C ","[IP and/or C&C domain]"," with the machine compromised by the ","[MD5 Hash]"," malware. Communications were executed at an interval of ","[Time interval]"," between client and server. They could be identified by searching for the regular expression ","[Identifying regular expression]"," in the proxy logs.\u201d"))),(0,o.kt)("p",null,"As you can imagine, this last type of indicator is the most valuable, as it has an associated context of what has happened and combines the atomic and calculated indicators. In addition, it is also easy to extract possible MITRE techniques and tactics to better understand what actions are being taken."),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://jstnk9.github.io/jstnk9/img/blog-indicator-life-cycle/hunt_1.png",alt:"Image_1"})),(0,o.kt)("p",null,"Now that we know the types of indicators that can be used in the indicator life cycle process, it is time to explain how the indicator life cycle works."),(0,o.kt)("p",null,"It consists of three main phases or stages, being the phases of developed, matured and used. In addition, this process is essential to involve people, processes and technology, which makes it really dynamic and useful in different operations, such as threat hunting."),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://jstnk9.github.io/jstnk9/img/blog-indicator-life-cycle/hunt_2.png",alt:"Image_2"})),(0,o.kt)("p",null,"Applying this model to our threat hunting activities will provide us with the following capabilities:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Generate internal threat intelligence"),(0,o.kt)("li",{parentName:"ol"},"Implement a stable pivoting process"),(0,o.kt)("li",{parentName:"ol"},"Identify new indicators from other indicators")),(0,o.kt)("h3",{id:"from-revealed-to-mature"},"From revealed to mature"),(0,o.kt)("p",null,"This first phase has different sources as input. In the image above, some of the sources that could be a source of information to start the cycle are shown. For example, external (or internal) reports, intelligence sources, SIEM or any other monitoring tool, such as an IDS."),(0,o.kt)("p",null,"The above mentioned sources will carry with them indicators, which should be subjected to an examination, which will consist of historically searching our available internal data sources to see whether or not such an indicator was observed in the past ( ",(0,o.kt)("a",{target:"_blank",href:"https://joseliyo-jstnk.medium.com/threat-hunting-but-where-and-what-collection-management-framework-33a2790f976f"}," see my post about collection management framework ")," ). In case the result is positive, further investigation is required to determine whether the activity was malicious or not."),(0,o.kt)("p",null,"With a positive result, countermeasures for ",(0,o.kt)("em",{parentName:"p"},"detection")," (in case the indicator becomes active again) and mitigation must be implemented internally, i.e., we ",(0,o.kt)("strong",{parentName:"p"},"not only want to detect but also actively prevent it from achieving its objectives.")),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://jstnk9.github.io/jstnk9/img/blog-indicator-life-cycle/hunt_3.png",alt:"Image_3"})),(0,o.kt)("p",null,"An indicator is considered mature when malicious activity has been retrospectively identified and detection and mitigation countermeasures have been implemented."),(0,o.kt)("h3",{id:"from-mature-to-utilized"},"From mature to utilized"),(0,o.kt)("p",null,"An indicator is ",(0,o.kt)("strong",{parentName:"p"},"utilized")," when the detection countermeasures are positive, i.e. the indicator has been identified by performing some action and is considered to have been used to detect a possible scenario that in principle should be malicious."),(0,o.kt)("p",null,"It is therefore important that the indicators have detection countermeasures in place, otherwise they can never be considered used, thus breaking the cycle completely and being unable to identify new indicators."),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://jstnk9.github.io/jstnk9/img/blog-indicator-life-cycle/hunt_4.png",alt:"Image_4"})),(0,o.kt)("h3",{id:"from-utilized-to-revealed"},"From utilized to revealed"),(0,o.kt)("p",null,"This stage of the cycle requires a great deal of interaction from the analysts as they will have to carry out an analysis of the events that have been detected in the previous stage. The reason is simple, the indicator itself is only a small portion of what could be an intrusion or attempt, i.e., it will be necessary to investigate the whole context of what could be happening and build a complete picture of the operation that the adversaries are carrying out."),(0,o.kt)("p",null,"During this analysis, it is very likely that new indicators will appear that were not previously known, so these indicators will have to be moved to the disclosed state again to start the cycle."),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://jstnk9.github.io/jstnk9/img/blog-indicator-life-cycle/hunt_5.png",alt:"Image_5"})),(0,o.kt)("p",null,"In those cases where a large number of new indicators are identified, or regardless of the quantity, quality should be prioritized. This means that there will be indicators that have more impact and more clearly detect malicious activity. An example could be a domain path, assuming that a malware communicates with baddomain.com/data?systeminfo=value, it is possible that we have seen another domain communicating with the same path, either because the malware incorporates several hardcoded domains in its code or any other reason, so it would be important to mature indicators to detect new behavior of other communications with /data?systeminfo=."),(0,o.kt)("h2",{id:"applying-the-cycle-in-threat-hunting-activities"},"Applying the cycle in threat hunting activities"),(0,o.kt)("p",null,"The entire life cycle of the indicators explained so far has a place in the famous threat hunting process, where the team first performs hypothesis generation by prioritizing the threats that could have the greatest impact on its activity. The next step is the pure hunting activity, where the other cycle can be implemented to structure the work even more and achieve objectives in a more effective way."),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://jstnk9.github.io/jstnk9/img/blog-indicator-life-cycle/hunt_6.png",alt:"Image_6"})),(0,o.kt)("p",null,"The discovery phase could also be framed within the life cycle of the indicators, more specifically with the mature stage, which would be those cases where some past behavior has been detected with the hunt being carried out by the team."),(0,o.kt)("h2",{id:"case-study"},"Case study"),(0,o.kt)("p",null,"Let\u2019s imagine that we are generating different scenarios internally to carry out hunting activities."),(0,o.kt)("h3",{id:"1--hypothesis-generation"},"#1 \u2014 Hypothesis generation"),(0,o.kt)("p",null,"We are interested in identifying the creation of scheduled tasks in the systems in the past, because an adversary who has special motivation in our company\u2019s sector could materialize an incident."),(0,o.kt)("p",null,(0,o.kt)("em",{parentName:"p"},"Objective"),": Identify suspicious scheduled tasks in the systems."),(0,o.kt)("p",null,(0,o.kt)("em",{parentName:"p"},"Searches"),": Windows events 4698 and 4702."),(0,o.kt)("h3",{id:"2---hunting"},"#2 - Hunting"),(0,o.kt)("p",null,"The team begins to perform threat hunting activities on the systems using whatever technology is available, be it EDR consoles, opensource tools, SIEM, etc\u2026"),(0,o.kt)("p",null,"A positive is identified in a system, where a scheduled task is checked."),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://jstnk9.github.io/jstnk9/img/blog-indicator-life-cycle/hunt_7.png",alt:"Image_7"})),(0,o.kt)("h3",{id:"3---revealed-to-mature"},"#3 - Revealed to mature"),(0,o.kt)("p",null,"The finding in this case can be verified as a scheduled task masked with a name of \u201cMozilla Firefox Update\u201d has been enabled by launching via command line a file named \u201cjstnk.exe\u201d found in the AppData directory."),(0,o.kt)("p",null,"At this point we would have two indicators, a calculated one and a behavioral one."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Computed indicator"),": MD5 hash of the file jstnk.exe"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"behavioral Indicator"),": An adversary sets the scheduled task \u201cMozilla Firefox Update\u201d (T1053.005) which executes the file jstnk.exe ","[MD5]","."),(0,o.kt)("p",null,"With both indicators, it is necessary to check retrospectively whether similar persistence has been performed on other systems in the corporate network, either with the same malware called jstnk.exe or using the same scheduled task technique."),(0,o.kt)("p",null,"If new computers are detected where persistence has been performed using T1053.005, countermeasures for detection and mitigation are therefore implemented."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Detection countermeasures"),": Execution of the command \u201cschtasks /create \u201c, focusing on files referenced in Appdata. A sigma rule similar to the following might be helpful -> ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/win_susp_schtask_creation.yml"},"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/win_susp_schtask_creation.yml")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Mitigation countermeasures"),": Establish a policy to limit the use of schtasks in the system."),(0,o.kt)("h3",{id:"4---mature-to-utilized"},"#4 - Mature to utilized"),(0,o.kt)("p",null,"In this case, let\u2019s imagine that the detection countermeasure mentioned above has worked, and new findings of scheduled task creation are appearing on other systems."),(0,o.kt)("p",null,"These detections therefore mean that the indicator has been utilized."),(0,o.kt)("h3",{id:"5---utilized-to-revealed"},"#5 - Utilized to revealed"),(0,o.kt)("p",null,"Analysts are starting to conduct research for alerts that have tested positive for creating scheduled tasks. What this triggers is that, it is becoming evident that the malware used for the persistence of this technique is different in all cases, but when the behavior is analyzed, many of the samples share infrastructure for communication with the C&Cs."),(0,o.kt)("p",null,"All these new indicators will go through the life cycle again to automate new detections and behaviors that may be related to the hunting being performed."),(0,o.kt)("h3",{id:"6--discovery"},"#6 \u2014 Discovery"),(0,o.kt)("p",null,"As the findings are aligned with the hypotheses that were generated in the first step, this stage of the threat hunting process means that as much information about the TTPs that have been used at a low level as possible will need to be collected in order to automate or document the findings."),(0,o.kt)("h3",{id:"7--report-and-enrichment"},"#7 \u2014 Report and enrichment"),(0,o.kt)("p",null,"Finally, the threat hunting process requires automating as much as possible the hunt mission carried out, so that the team does not waste time running the same mission every X amount of time and can focus their efforts on developing new missions for other techniques that may be being used in the corporate networks."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Twitter"),": ",(0,o.kt)("a",{parentName:"p",href:"https://twitter.com/Joseliyo_Jstnk"},"https://twitter.com/Joseliyo_Jstnk")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"LinkedIn"),": ",(0,o.kt)("a",{parentName:"p",href:"https://www.linkedin.com/in/joseluissm/"},"https://www.linkedin.com/in/joseluissm/")))}p.isMDXComponent=!0}}]);